---
title: "Auto"
author: "Ragnar"
date: "February 26, 2019"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
    theme: lumen
---

# Libraries

```{r, message=FALSE, warning=FALSE}
# Libraries ----
library(readxl) # read exlce
library(dplyr) # For table manipulations
library(plyr) # For table manipulations
library(reshape2) # For melt function to chane data frames to parse into ggplot functions
library(ggplot2) # For Nice plots
```

# Functions
```{r, warning=FALSE}


# General functions call
source("functions.R")
# GLM - parameters

# Call the GLM.R script, estimates number and AAC for current automoblies. Also
source("GLM.R")


# Premiums for each autonomu class
source("autonomyClaimAmounts.R")

# Proportions of Risk Classes within autonomy classes
source("RiskClassProp.R")

# Autonomy Proportions
source("autonomyProportions.R")

```


# Base Scenario

Insert initial variables

```{r, warning=FALSE}
time.frame <- 0:10
start.year <- 2019
t <- seq(min(time.frame), max(time.frame), by = 0.25)
```


## Frequency and Claim multipliers
```{r, warning=FALSE}
# Define as lists, same names 
freq.pct <- list()

freq.pct$A0 <- data.frame(time = t, NC_BI.pct = rep(1, length(t)), NC_PD.pct = rep(1, length(t)), NC_COM.pct = rep(1, length(t)), NC_COL.pct = rep(1, length(t)), NC_PI.pct = rep(1, length(t)))
freq.pct$A1 <- data.frame(time = t, NC_BI.pct = 0.5 - 0.01*t, NC_PD.pct = 0.5 - 0.01*t, NC_COM.pct = rep(1, length(t)), NC_COL.pct = 0.5 - 0.01*t, NC_PI.pct = 0.5 - 0.01*t)
freq.pct$A2 <- data.frame(time = t, NC_BI.pct = 0.2 - 0.01*t, NC_PD.pct = 0.2 - 0.01*t, NC_COM.pct = rep(1, length(t)), NC_COL.pct = 0.2 - 0.01*t, NC_PI.pct = 0.2 - 0.01*t)

loss.pct <- list()
loss.pct$A0 <- data.frame(time = t, AAC_BI.pct = rep(1, length(t)), AAC_PD.pct = rep(1, length(t)), AAC_COM.pct = rep(1, length(t)), AAC_COL.pct = rep(1, length(t)), AAC_PI.pct = rep(1, length(t)))
loss.pct$A1 <- data.frame(time = t, AAC_BI.pct = rep(1, length(t)), AAC_PD.pct = rep(1, length(t)), AAC_COM.pct = rep(1.3, length(t)), AAC_COL.pct = rep(1.3, length(t)), AAC_PI.pct = rep(1, length(t)))
loss.pct$A2 <- data.frame(time = t, AAC_BI.pct = rep(1, length(t)), AAC_PD.pct = rep(1, length(t)), AAC_COM.pct = rep(1.5, length(t)), AAC_COL.pct = rep(1.5, length(t)), AAC_PI.pct = rep(1, length(t)))

```


## Safelife marketshare

```{r, warning=FALSE}
A0 <- 0.34 + 0.005*t
A1 <- exp(-t*0.35)*0.66 +0.34
A2<- exp(-t*0.3)*0.66 +0.34

safelife.market.share <- data.frame(time = t,
                                    A0 = A0,
                                    A1 = A1,
                                    A2 = A2)

m.safe <- melt(data = safelife.market.share, id = "time")

ggplot(data = m.safe) + geom_line(mapping = aes(x = time, y = value, color = variable))


```



## Carbia market exposure Personal in percetnages

```{r, warning=FALSE}

A0 <- 1 - (t^2)*0.002
A2 <- function(t){
  if(t<5){
    0
  }else{
    exp(0.015*(t-5))-1
  }
}
A2 <- Vectorize(FUN = A2, vectorize.args = "t")
A1 <- 1-A0-A2(t)

carb.personal.pct <- data.frame(time = t,
                                A0 = A0,
                                A1 = A1,
                                A2 = A2(t))

m.carb <- melt(data = carb.personal.pct, id.vars = "time")

ggplot(data = m.carb) + geom_line(mapping = aes(x = time, y = value, color = variable))


```

## Carbia commercial percentages

```{r, warning=FALSE}
A1 <- exp(0.015*t)-1
A2 <- function(t){
  if(t<3){
    0
  }else{
    0.0023*(t-3)^2#exp(0.015*(t-3))-1
  }
}
A2 <- Vectorize(FUN = A2, vectorize.args = "t")
A0 <- 1-A1-A2(t)

carb.commercial.pct <- data.frame(time = t,
                                A0 = A0,
                                A1 = A1,
                                A2 = A2(t))

m.carb <- melt(data = carb.commercial.pct, id.vars = "time")
m.carb$variable <- factor(m.carb$variable, levels = c("A2", "A1", "A0"), ordered = T)

ggplot(data = m.carb) + geom_bar(mapping = aes(x = time, y = value, fill = variable) , stat = "identity") + 
  scale_fill_manual(values=c("#027984", "#0d0284", "#0755c1"))
ggplot(data = m.carb) + geom_line(mapping = aes(x = time, y = value, color = variable))

```


## Carbia total Exposure growth for Commercial and Personal

```{r, warning=FALSE}
### Exposure of Personal and Commermcial
mark.share.p <- 0.34
mark.share.c <- 0.34

personal.exposure <- sum(autocar$Exposure[autocar$Year == 2018 & autocar$Qtr == 4 & autocar$Type == "Personal"])/mark.share.p
commercial.exposure <- sum(autocar$Exposure[autocar$Year == 2018 & autocar$Qtr == 4 & autocar$Type == "Commercial"])/mark.share.c 

carbia.exposure <- data.frame(time = t,
                              Personal = personal.exposure*(1+t*0),
                              Commercial = commercial.exposure*(1+0.05)^t)


m.carbia.exposure <- melt(data = carbia.exposure, id.vars = c("time"))

ggplot(data = m.carbia.exposure) + geom_line(mapping = aes(x = time, y = value, color = variable))


```


## Model


```{r, warning=FALSE}


predict.df <- model.2(time.frame = time.frame, autocar = autocar, glm.list = glm$rd, safelife.market.share = safelife.market.share, carbia.exposure = carbia.exposure, carb.commercial.pct = carb.commercial.pct, carb.personal.pct = carb.personal.pct, freq.pct = freq.pct, loss.pct = loss.pct)


```



## plots
```{r}
  plots <- list()

  # Total Exposure Growth
  tmp <- predict.df[, names(predict.df) %in% c("time", "Exposure")]
  tmp <- aggregate(formula = . ~ time , data = tmp, FUN = sum)
  plots$total.exposure <- ggplot(data = tmp) + geom_line(aes(x = time, y = Exposure)) + ggtitle("Total Exposure evolution") + theme(plot.title = element_text(size = 10))

  plots$total.exposure
  
  # Autonomy evolution
  tmp <- predict.df[, names(predict.df) %in% c("time", "Exposure", "Autonomy")]
  tmp <- aggregate(formula = . ~ time + Autonomy, data = tmp, FUN = sum)
  plots$Autonomy.evolution <- ggplot(data = tmp) + geom_line(aes(x = time, y = Exposure, color = Autonomy)) + ggtitle("Total Autonomy evolution") + theme(plot.title = element_text(size = 10))
  
  plots$Autonomy.evolution
  
  # Personal evolution
  tmp <- predict.df[predict.df$Type == "Personal", names(predict.df) %in% c("time", "Exposure", "Autonomy")]
  tmp <- aggregate(formula = . ~ time + Autonomy, data = tmp, FUN = sum)
  plots$Autonomy.evolution.personal <- ggplot(data = tmp) + geom_line(aes(x = time, y = Exposure, color = Autonomy)) + ggtitle("Total Autonomy evolution for personal") + theme(plot.title = element_text(size = 10))
  
  plots$Autonomy.evolution.personal
  
  # Commercial evolution
  tmp <- predict.df[predict.df$Type == "Commercial", names(predict.df) %in% c("time", "Exposure", "Autonomy")]
  tmp <- aggregate(formula = . ~ time + Autonomy, data = tmp, FUN = sum)
  plots$Autonomy.evolution.commercial <- ggplot(data = tmp) + geom_line(aes(x = time, y = Exposure, color = Autonomy)) + ggtitle("Total Autonomy commercial") + theme(plot.title = element_text(size = 10))
  
  plots$Autonomy.evolution.commercial
  
  # PLot the Autonomy evolutions
  
  # multiplot(plots$Autonomy.evolution.personal, plots$Autonomy.evolution, plots$Autonomy.evolution.commercial, cols = 2)
  
  
  # Plot Claims evolution personal
  tmp <- predict.df[, names(predict.df) %in% c("time", "Autonomy", "Type", "NC_BI", "NC_PD", "NC_COM", "NC_COL", "NC_PI")]
  tmp <- aggregate(formula = . ~ time + Autonomy + Type, data = tmp, FUN = mean)
  tmp.melt <- melt(data = tmp, id = c("time", "Autonomy", "Type"))
  
  plots$frequency.Personal <- ggplot(data = tmp.melt[tmp.melt$Type == "Personal", ]) + geom_line(mapping = aes(x = time, y = value, color = Autonomy)) + facet_wrap(facets = . ~ variable, scales = "free") + ggtitle("Personal frequency evolution aggregated With mean")
  
  plots$frequency.Personal
  
  # plot amount evolution personal
  tmp <- predict.df[, names(predict.df) %in% c("time", "Autonomy", "Type", "AAC_BI", "AAC_PD", "AAC_COM", "AAC_COL", "AAC_PI")]
  tmp <- aggregate(formula = . ~ time + Autonomy + Type, data = tmp, FUN = mean)
  tmp.melt <- melt(data = tmp, id = c("time", "Autonomy", "Type"))
  
  plots$amount.Personal <- ggplot(data = tmp.melt[tmp.melt$Type == "Personal", ]) + geom_line(mapping = aes(x = time, y = value, color = Autonomy)) + facet_wrap(facets = . ~ variable, scales = "free") + ggtitle("Personal mount evolution aggregated With mean")

  plots$amount.Personal
  
  # Plot Claims evolution Commercial
  tmp <- predict.df[, names(predict.df) %in% c("time", "Autonomy", "Type", "NC_BI", "NC_PD", "NC_COM", "NC_COL", "NC_PI")]
  tmp <- aggregate(formula = . ~ time + Autonomy + Type, data = tmp, FUN = mean)
  tmp.melt <- melt(data = tmp, id = c("time", "Autonomy", "Type"))
  
  plots$frequency.Commercial <- ggplot(data = tmp.melt[tmp.melt$Type == "Commercial", ]) + geom_line(mapping = aes(x = time, y = value, color = Autonomy)) + facet_wrap(facets = . ~ variable, scales = "free") + ggtitle("Commercial frequency evolution aggregated With mean")
  
  plots$frequency.Commercial
  # plot amount evolution Commercial
  tmp <- predict.df[, names(predict.df) %in% c("time", "Autonomy", "Type", "AAC_BI", "AAC_PD", "AAC_COM", "AAC_COL", "AAC_PI")]
  tmp <- aggregate(formula = . ~ time + Autonomy + Type, data = tmp, FUN = sum)
  tmp.melt <- melt(data = tmp, id = c("time", "Autonomy", "Type"))
  
  plots$amount.Commercial <- ggplot(data = tmp.melt[tmp.melt$Type == "Commercial", ]) + geom_line(mapping = aes(x = time, y = value, color = Autonomy)) + facet_wrap(facets = . ~ variable, scales = "free") + ggtitle("Commercial amount evolution aggregated With mean")
  plots$amount.Commercial
  
  # Pure Premium
  tmp <- predict.df[, c("time", "Autonomy", "Type", "pure.premium.BI", "pure.premium.PD", "pure.premium.COM", "pure.premium.COL", "pure.premium.PI")]
  tmp <- aggregate(formula = . ~ time + Autonomy + Type, data = tmp, FUN = sum)
  tmp.melt <- melt(data = tmp, id.vars = c("time", "Autonomy", "Type"))
  
  plots$pure.prem <- ggplot(data = tmp.melt) + geom_line(mapping = aes(x = time, y = value, color = Autonomy)) + facet_wrap(. ~ Type + variable, scales = "free")
  
  plots$pure.prem
  
  # loss
    tmp <- predict.df[, c("time", "Autonomy", "Type", "loss.BI", "loss.PD", "loss.COM", "loss.COL", "loss.PI")]
  tmp <- aggregate(formula = . ~ time + Autonomy + Type, data = tmp, FUN = mean)
  tmp.melt <- melt(data = tmp, id.vars = c("time", "Autonomy", "Type"))
  
  plots$loss<- ggplot(data = tmp.melt) + geom_line(mapping = aes(x = time, y = value, color = Autonomy)) + facet_wrap(. ~ Type + variable, scales = "free")
  
  plots$loss
  
```











